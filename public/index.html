<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marvel API Form</title>
</head>
<body>
  <h1>Marvel Character Form</h1>
  <form id="form">
    <label for="name">Name:</label>
    <input type="text" id="name" name="name"><br><br>
    <label for="email">Email:</label>
    <input type="email" id="email" name="email"><br><br>
    <label for="favoriteCharacter">Favorite Marvel Character:</label>
    <input type="text" id="favoriteCharacter" name="favoriteCharacter"><br><br>
    <label for="comments">Comments:</label>
    <textarea id="comments" name="comments"></textarea><br><br>
    <button type="submit">Submit</button>
  </form>

  <h2>All Responses</h2>
  <div id="responses"></div>

  <h2>Marvel Character Search</h2>
  <input type="text" id="character-search" placeholder="Enter character name">
  <button id="search-button">Search</button>
  <div id="character-info"></div>

  <script>
    document.getElementById('form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        favoriteCharacter: document.getElementById('favoriteCharacter').value,
        comments: document.getElementById('comments').value
      };

      const response = await fetch('/api', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });
      const result = await response.json();
      alert('Form submitted with ID: ' + result.id);
      loadResponses();
    });

    async function loadResponses() {
      const response = await fetch('/api');
      const responses = await response.json();
      const responseDiv = document.getElementById('responses');
      responseDiv.innerHTML = '';

      for (let r of responses) {
        const res = await fetch(`/api/${r._id}`);
        const detailedResponse = await res.json();

        const marvelResponse = await fetch(`/api/marvel/${encodeURIComponent(detailedResponse.favoriteCharacter)}`);
        const marvelData = await marvelResponse.json();
        const character = marvelData.data.results[0];

        const characterInfo = character ? `<p>Character: ${character.name}<br>Description: ${character.description}</p>` : '<p>Character not found in Marvel API.</p>';

        responseDiv.innerHTML += `
          <div>
            <p>Name: ${detailedResponse.name}</p>
            <p>Email: ${detailedResponse.email}</p>
            <p>Favorite Character: ${detailedResponse.favoriteCharacter}</p>
            <p>Comments: ${detailedResponse.comments}</p>
            ${characterInfo}
          </div>
          <hr>
        `;
      }
    }

    loadResponses();

    document.getElementById('search-button').addEventListener('click', async function () {
      const characterName = document.getElementById('character-search').value;
      const response = await fetch(`/api/marvel/${encodeURIComponent(characterName)}`);
      const data = await response.json();
      const character = data.data.results[0];
      const characterInfoDiv = document.getElementById('character-info');
      characterInfoDiv.innerHTML = `<h3>${character.name}</h3><p>${character.description}</p>`;
    });
  </script>
</body>
</html>
